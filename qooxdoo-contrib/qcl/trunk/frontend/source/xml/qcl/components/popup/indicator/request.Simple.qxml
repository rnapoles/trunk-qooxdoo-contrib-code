<?xml version="1.0" encoding="utf-8"?>
<qxt:include-definition
  xmlns:qx="http://www.qxtransformer.org/qooxdoo"
	xmlns:qxt="http://www.qxtransformer.org/extension"
  >
	
	<!-- loading indicator -->
  <!-- todo: cancel requests selectively -->
  
	<qx:popup
		height="auto" width="auto" autoHide="false"
		onAppear="this.centerToBrowser()">
			<qx:atom
				border="outset-thin"
				padding="10"
				icon="icon/16/actions/ajax-loader.gif" 
				label="Loading, please wait..." 
				backgroundColor="white">
				
				<qx:messageSubscriber filter="qcl.databinding.messages.rpc.*">
					<![CDATA[
					var status = message.getName();
					var timestamp = message.getData()
					var queue = this.getUserData("queue") || [];
					switch ( status )
					{
					  case "qcl.databinding.messages.rpc.start":
					    queue.push(timestamp);
					    break;
					  
					  case "qcl.databinding.messages.rpc.end":
					    for ( var i=0; i < queue.length; i++)
					    {
					      if (queue[i]==timestamp)
					      {
					        queue.splice(i,1);
					      }
					    }
					    break; 
					}
					this.setUserData("queue",queue);
					if (queue.length) {
						this.getParent().show();
					} else {
						this.getParent().hide();
					}
					]]>
				</qx:messageSubscriber>
        
        <!-- clear queue and hide popup -->
        <qx:eventListener type="click">
          this.setUserData("queue",[]);
          this.getParent().hide();
        </qx:eventListener>		
        
		</qx:atom>
		
	</qx:popup>		
	
</qxt:include-definition>
	