<?xml version="1.0" encoding="utf-8"?>
<qxt:include-definition
	xmlns:qx="http://www.qooxdoo.org"
	xmlns:qxt="http://www.qxtransformer.sourceforge.net/extension">

	<!-- utility scripts -->
	<qxt:script>
		function utf8_encode( string )
		{
		  return unescape( encodeURIComponent( string ) );
		}
		
		function utf8_decode( string )
		{
		  return decodeURIComponent( escape( s ) );
		}
		
		// patch current qooxdoo code
		
		qx.ui.core.Widget.prototype.supportsDrop = function (dragCache)
		{
      var supportsDropMethod = this.getSupportsDropMethod();
      if (supportsDropMethod !== null) {
        return supportsDropMethod.call(this, dragCache);
      }
      return true;
		};
		
		qx.event.handler.DragAndDropHandler.prototype.getDropTarget = qx.core.Variant.select("qx.client",
    {
      "gecko" : function(e)
      {
        var vCurrent = e.getTarget();

//        if (vCurrent == this.__dragCache.sourceWidget) {
//          vCurrent = qx.event.handler.EventHandler.getTargetObject(qx.html.ElementFromPoint.getElementFromPoint(e.getPageX(), e.getPageY()));
//        } else {
          vCurrent = qx.event.handler.EventHandler.getTargetObject(null, vCurrent);
//        }

        while (vCurrent != null)
        {

          if (!vCurrent.supportsDrop(this.__dragCache)) {
            return null;
          }

          if (this.supportsDrop(vCurrent)) {
            return vCurrent;
          }

          vCurrent = vCurrent.getParent();
        }

        return null;
      },

      "default" : function(e)
      {
        var vCurrent = e.getTarget();

        while (vCurrent != null)
        {
          if (!vCurrent.supportsDrop(this.__dragCache)) {
            return null;
          }

          if (this.supportsDrop(vCurrent)) {
            return vCurrent;
          }

          vCurrent = vCurrent.getParent();
        }

        return null;
      }
    });
		
	</qxt:script>
	
</qxt:include-definition>