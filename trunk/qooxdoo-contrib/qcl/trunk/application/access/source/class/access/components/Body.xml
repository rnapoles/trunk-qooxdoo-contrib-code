<?xml version="1.0" encoding="utf-8"?>
<qxt:component xmlns:qx="http://www.qxtransformer.org/qooxdoo/0.8"
  xmlns:qxt="http://www.qxtransformer.org/extension/0.4" xmlns:qcl="http://www.qooxdoo.org/contrib/qcl/trunk"
  author="Christian Boulanger" className="access.components.Body"
  tagName="body">

  <qx:composite margin="30">
    <qx:vbox>

      <qx:composite >
        <qx:hbox spacing="10" qxt:flex="1">

          <qx:groupBox qxt:flex="1" legend="User Data">
            <qx:vbox spacing="5">

              <qx:label rich="true" qxt:flex="1" width="200" allowStretchX="true">
                <qxt:property name="value">
                  &lt;h4&gt;Login data &lt;/h4&gt;
                   &lt;ul&gt;
                    &lt;li&gt;User1: user1/user1&lt;/li&gt;
                    &lt;li&gt;User2: user2/user2&lt;/li&gt;
                    &lt;li&gt;Manager: user3/user3&lt;/li&gt;
                    &lt;li&gt;Administrator: admin/admin&lt;/li&gt;
                   &lt;/ul&gt;
                   &lt;p&gt;Click on "Login" to log in as one of these users.&lt;/p&gt;
                   &lt;p&gt;Also note that you can reload the page and still be logged in with
                   the same user.&lt;/p&gt;
                   
                   &lt;h4&gt;Current user&lt;/h4&gt;
                </qxt:property>
              </qx:label>
              
              <qx:composite>
              <qx:grid spacing="5">
                <qx:column minWidth="100" />
                <qx:column flex="2"/>
                
                <qx:label value="Username:" qxt:row="0" qxt:column="0"/>
                <qx:label qxt:row="0" qxt:column="1">
                  <qxt:observe 
                    property="value" 
                    source="this.getApplication().getUserManager()" 
                    sourceProp="activeUser.username" />
                </qx:label >
                
                <qx:label value="Full name:" qxt:row="1" qxt:column="0"/>
                <qx:label qxt:row="1" qxt:column="1">
                  <qxt:observe 
                    property="value" 
                    source="this.getApplication().getUserManager()" 
                    sourceProp="activeUser.fullname" />                
                </qx:label >

                
                <qx:label value="Permissions:" qxt:row="2" qxt:column="0"/>
                <qx:label qxt:row="2" qxt:column="1" rich="true">
                  <qxt:observe 
                    property="value" 
                    source="this.getApplication().getUserManager()" 
                    sourceProp="activeUser"
                    converter="function(activeUser){return activeUser ? activeUser.getPermissionNames().join('&lt;br /&gt;') : ''}" />                
                </qx:label>
                
              </qx:grid>
              </qx:composite>
            </qx:vbox>  
          </qx:groupBox>

          <qx:groupBox qxt:flex="1" legend="Permission binding">
            <qx:vbox spacing="5">
            
              <qx:button label="Permission 'viewRecord' (Anyone)" >
                <qcl:observe property="enabled" permission="viewRecord" />
              </qx:button>
            
              <qx:button label="Permission 'createRecord' (All authenticated)" >
                <qcl:observe property="enabled" permission="createRecord" />
              </qx:button>
              
              <qx:button label="Permission 'manageConfig' (All authenticated))" >
                <qcl:observe property="enabled" permission="createRecord" />
              </qx:button>
              
              <qx:button label="Permission 'deleteRecord' (Manager only)" >
                <qcl:observe property="enabled" permission="deleteRecord" />
              </qx:button>
              
              <qx:button label="Permission 'manageUsers' (Admin only)" >
                <qcl:observe property="enabled" permission="manageUsers" />
              </qx:button>
              
              <qx:checkBox id="condition1CheckBox" label="Condition 1">
                <qxt:listener event="changeValue" dispatchEvent="conditionsHaveChanged" />
              </qx:checkBox>
              <qx:checkBox id="condition2CheckBox" label="Condition 2">
                <qxt:listener event="changeValue" dispatchEvent="conditionsHaveChanged" />
              </qx:checkBox>
              <qx:checkBox id="condition3CheckBox" label="Condition 3" >
                <qxt:listener event="changeValue" dispatchEvent="conditionsHaveChanged" />
              </qx:checkBox>
              
              <qcl:access>
                <qcl:permission name="createRecordCondition1" granted="true">
                  <qcl:dependency permission="createRecord" />
                  <qcl:updater event="conditionsHaveChanged" />
                  <qcl:condition>return condition1CheckBox.getValue()==true;</qcl:condition>
                </qcl:permission>
                
                <qcl:permission name="createRecordCondition2" granted="true">
                  <qcl:dependency permission="createRecordCondition1" />
                  <qcl:updater event="conditionsHaveChanged" />
                  <qcl:condition>return condition2CheckBox.getValue()==true;</qcl:condition>
                </qcl:permission>
                
                <qcl:permission name="createRecordCondition3" granted="true">
                  <qcl:dependency permission="createRecordCondition2" />
                  <qcl:updater event="conditionsHaveChanged" />
                  <qcl:condition>return condition3CheckBox.getValue()==true;</qcl:condition>
                </qcl:permission>                                
              </qcl:access>
              
              <qx:button label="Permission 'createRecord' and condition 1" >
                <qcl:observe property="enabled" permission="createRecordCondition1" />
              </qx:button>           

              <qx:button label="Permission 'createRecord' and condition 1,2" >
                <qcl:observe property="enabled" permission="createRecordCondition2" />
              </qx:button>         
              
              <qx:button label="Permission 'createRecord' and condition 1,2,3" >
                <qcl:observe property="enabled" permission="createRecordCondition3" />
              </qx:button>                                     
              
            </qx:vbox>
          
          </qx:groupBox>

          <qx:groupBox qxt:flex="1" legend="Configuration">
          
            <qx:vbox spacing="5">
            
              <qx:label rich="true" qxt:flex="1" width="200" allowStretchX="true">
                <qxt:property name="value">
                   &lt;p&gt;Users can change configuration values according to their permissions.&lt;/p&gt;
                   &lt;p&gt;Note that changes are sent to the server and persist through page reloads.&lt;/p&gt;
                </qxt:property>
              </qx:label>          

              <qx:composite>
              <qx:grid spacing="5">
                <qx:column minWidth="100" />
                <qx:column flex="2"/>
                
                <qx:label value="application.name" qxt:row="0" qxt:column="0">
                  <qcl:observe property="enabled" permission="manageUsers" />
                </qx:label>
                <qx:textField qxt:row="0" qxt:column="1">
                  <qcl:observe property="enabled" permission="manageUsers" />
                  <qcl:bind property="value" config="application.name"  />
                </qx:textField>
                
                <qx:label value="application.author" qxt:row="1" qxt:column="0">
                  <qcl:observe property="enabled" permission="manageUsers" />
                </qx:label>
                <qx:textField qxt:row="1" qxt:column="1">
                  <qcl:observe property="enabled" permission="manageUsers" />
                  <qcl:bind property="value" config="application.author"  />              
                </qx:textField>
                
                <qx:label value="test.checked" qxt:row="2" qxt:column="0">
                  <qcl:observe property="enabled" permission="manageConfig"/>
                </qx:label>
                <qx:checkBox qxt:row="2" qxt:column="1">
                  <qcl:observe property="enabled" permission="manageConfig"/>
                  <qcl:bind property="value" config="test.checked"  />
                </qx:checkBox>
                
                <qx:label value="test.value" qxt:row="3" qxt:column="0">
                  <qcl:observe property="enabled" permission="manageConfig"/>
                </qx:label>
                <qx:textField qxt:row="3" qxt:column="1">
                  <qcl:observe property="enabled" permission="manageConfig"/>
                  <qcl:bind property="value" config="test.value"  />              
                </qx:textField>                
                
              </qx:grid>
              </qx:composite>
              
              <qx:label rich="true" qxt:flex="1" width="200" allowStretchX="true">
                <qxt:property name="value">
                   &lt;p&gt;The following config value is deliberately unprotected 
                   by permissions so that an anonymous user can change it  
                   on the client. However, when the change is sent to the 
                   server, it will refuse to update it.&lt;/p&gt;
                </qxt:property>
              </qx:label>    
              
            <qx:composite>
              <qx:grid spacing="5">
                <qx:column minWidth="100" />
                <qx:column flex="2"/>                
                <qx:label value="test.value" qxt:row="0" qxt:column="0"/>
                <qx:textField qxt:row="0" qxt:column="1">
                  <qcl:bind property="value" config="test.value"  />              
                </qx:textField>                
                
              </qx:grid>
              </qx:composite>

            </qx:vbox>
          </qx:groupBox>

        </qx:hbox>
      </qx:composite>
      
      <!-- source code -->
      <qx:groupBox legend="Source">
        <qx:hbox spacing="5">
           <qx:button label="Application JS source">
            <qxt:listener event="execute">
              window.open("../source/class/access/Main.js");
            </qxt:listener>            
           </qx:button>          
           <qx:button label="Toolbar XML source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/ToolBar.xml");
            </qxt:listener>
           </qx:button>
           <qx:button label="Toolbar Js source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/ToolBar.js");
            </qxt:listener>
           </qx:button>           
           <qx:button label="Body XML source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/Body.xml");
            </qxt:listener>
           </qx:button>
           <qx:button label="Body JS source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/Body.js");
            </qxt:listener>            
           </qx:button>        
        </qx:hbox>
      </qx:groupBox>

    </qx:vbox>
  </qx:composite>

</qxt:component>