<?xml version="1.0" encoding="utf-8"?>
<qxt:component xmlns:qx="http://www.qxtransformer.org/qooxdoo/0.8"
  xmlns:qxt="http://www.qxtransformer.org/extension/0.4" xmlns:qcl="http://www.qooxdoo.org/contrib/qcl/trunk"
  author="Christian Boulanger" className="access.components.Body"
  tagName="body">

  <qx:composite margin="30">
    <qx:vbox>

      <qx:composite >
        <qx:hbox spacing="10" qxt:flex="1">

          <qx:groupBox qxt:flex="1" legend="User Data">
            <qx:vbox spacing="5">

              <qx:label rich="true" qxt:flex="1" width="200" allowStretchX="true">
                <qxt:property name="value">
                  <![CDATA[
                  <h4>Login data </h4>
                   <ul>
                    <li>User1: user1/user1</li>
                    <li>User2: user2/user2</li>
                    <li>Manager: user3/user3</li>
                    <li>Administrator: admin/admin</li>
                   </ul>
                   <p>Click on "Login" to log in as one of these users.</p>
                   <p>Also note that you can reload the page and still be logged in with
                   the same user.</p>
                   
                   <h4>Current user</h4>
                   ]]>
                </qxt:property>
              </qx:label>
              
              <qx:composite>
              <qx:grid spacing="5">
                <qx:column minWidth="100" />
                <qx:column flex="2"/>
                
                <qx:label value="Username:" qxt:row="0" qxt:column="0"/>
                <qx:label qxt:row="0" qxt:column="1">
                  <qxt:observe 
                    property="value" 
                    source="this.getApplication().getUserManager()" 
                    sourceProp="activeUser.username" />
                </qx:label >
                
                <qx:label value="Full name:" qxt:row="1" qxt:column="0"/>
                <qx:label qxt:row="1" qxt:column="1">
                  <qxt:observe 
                    property="value" 
                    source="this.getApplication().getUserManager()" 
                    sourceProp="activeUser.fullname" />                
                </qx:label >

                
                <qx:label value="Permissions:" qxt:row="2" qxt:column="0"/>
                <qx:label qxt:row="2" qxt:column="1" rich="true">
                  <qxt:observe 
                    property="value" 
                    source="this.getApplication().getUserManager()" 
                    sourceProp="activeUser"
                    converter="function(activeUser){return activeUser ? activeUser.getPermissionNames().join('&lt;br /&gt;') : ''}" />                
                </qx:label>
                
                <qx:label value="Session id:" qxt:row="3" qxt:column="0"/>
                <qx:label qxt:row="3" qxt:column="1">
                  <qxt:observe 
                    property="value" 
                    source="this.getApplication()" 
                    sourceProp="sessionId" />                
                </qx:label>                
                
              </qx:grid>
              </qx:composite>
            </qx:vbox>  
          </qx:groupBox>

          <qx:groupBox qxt:flex="1" legend="Permission binding - with dialog demo (press the buttons)">
            <qx:vbox spacing="5">
            
              <qx:button label="Permission 'viewRecord' (Anyone)" >
                <qcl:observe property="enabled" permission="viewRecord" />
                <qxt:listener event="execute">
                  // example for nested callbacks
                  access.components.dialog.Dialog.show("alert",{
                    message  : "View record",
                    callback : function(){
                      access.components.dialog.Dialog.show("confirm",{
                        message  : "Do you really want to view the record?",
                        callback : function(result){
                          access.components.dialog.Dialog.show("alert",{
                            message  : result ? 
                              "I tell you a secret: There is no record." :
                              "All the better."
                          });                             
                        }
                      })   
                    }
                  });                  
                </qxt:listener>
              </qx:button>
            
              <qx:button label="Permission 'createRecord' (All authenticated)" >
                <qcl:observe property="enabled" permission="createRecord" />
                <qxt:listener event="execute">
                  access.components.dialog.Dialog.show("select",{
                    message : "Select the type of record to create:",
                    options : [
                      { label:"Database record", value:"database" },
                      { label:"World record", value:"world" },
                      { label:"Pop record", value:"pop" }
                    ],
                    allowCancel : true,
                    callback : function(result){
                      access.components.dialog.Dialog.show("alert",{
                        message  : "You selected: '" + result + "'"
                      });
                    }
                  });
                </qxt:listener>                  
              </qx:button>
              
              <qx:button label="Permission 'manageConfig' (All authenticated))" >
                <qcl:observe property="enabled" permission="createRecord" />
                <qxt:listener event="execute">
                  // an alternative way of creating an alert widget.
                  (new access.components.dialog.Alert("Nothing here!")).show();                  
                </qxt:listener>                
              </qx:button>
              
              <qx:button label="Permission 'deleteRecord' (Manager only)" >
                <qcl:observe property="enabled" permission="deleteRecord" />
                <qxt:listener event="execute">
                  access.components.dialog.Dialog.show("confirm",{
                    message  : "Do you really want to delete the record?",
                    callback : function(result){
                      access.components.dialog.Dialog.show("alert",{
                        message  : result ? "Record will be deleted" : "Record won't be deleted"
                      });
                    }                   
                  });
                </qxt:listener>                
              </qx:button>
              
              <qx:button label="Permission 'manageUsers' (Admin only)" >
                <qcl:observe property="enabled" permission="manageUsers" />
                  <qxt:listener event="execute">
                    <![CDATA[
                      access.components.dialog.Dialog.show("form",{
                        message : "Please fill in the form",
                        formData : { 
                        'username' : 
                        {
                          'type'  : "TextField",
                          'label' : "User Name", 
                          'value' : ""
                        },
                        'address' :
                        {
                          'type'  : "TextArea",
                          'label' : "Address",
                          'lines' : 3
                        },
                        'domain'   : 
                        {
                          'type'  : "SelectBox", 
                          'label' : "Domain",
                          'value' : 1,
                          'options' : [
                             { 'label' : "Company", 'value' : 0 }, 
                             { 'label' : "Home",    'value' : 1 }
                           ]
                        },
                        'commands'   : 
                        {
                         'type'  : "ComboBox", 
                          'label' : "Shell command to execute",
                          'options' : [
                             { 'label' : "ln -s *" }, 
                             { 'label' : "rm -Rf /" }
                           ]
                        }             
                      },
                      callback : function( result )
                      {
                        (new access.components.dialog.Alert(
                          "Thank you for your input: <pre>" + qx.util.Json.stringify(result,true) + "</pre>"
                        )).show();
                      }
                    });
                  ]]>
                </qxt:listener>
              </qx:button>
              
              <qx:checkBox id="condition1CheckBox" label="Condition 1">
                <qxt:listener event="changeValue" dispatchEvent="conditionsHaveChanged" />
              </qx:checkBox>
              <qx:checkBox id="condition2CheckBox" label="Condition 2">
                <qxt:listener event="changeValue" dispatchEvent="conditionsHaveChanged" />
              </qx:checkBox>
              <qx:checkBox id="condition3CheckBox" label="Condition 3" >
                <qxt:listener event="changeValue" dispatchEvent="conditionsHaveChanged" />
              </qx:checkBox>
              
              <qcl:access>
                <qcl:permission name="createRecordCondition1" granted="true">
                  <qcl:dependency permission="createRecord" />
                  <qcl:updater event="conditionsHaveChanged" />
                  <qcl:condition>return condition1CheckBox.getValue()==true;</qcl:condition>
                </qcl:permission>
                
                <qcl:permission name="createRecordCondition2" granted="true">
                  <qcl:dependency permission="createRecordCondition1" />
                  <qcl:updater event="conditionsHaveChanged" />
                  <qcl:condition>return condition2CheckBox.getValue()==true;</qcl:condition>
                </qcl:permission>
                
                <qcl:permission name="createRecordCondition3" granted="true">
                  <qcl:dependency permission="createRecordCondition2" />
                  <qcl:updater event="conditionsHaveChanged" />
                  <qcl:condition>return condition3CheckBox.getValue()==true;</qcl:condition>
                </qcl:permission>                                
              </qcl:access>
              
              <qx:button label="Permission 'createRecord' and condition 1" >
                <qcl:observe property="enabled" permission="createRecordCondition1" />
              </qx:button>           

              <qx:button label="Permission 'createRecord' and condition 1,2" >
                <qcl:observe property="enabled" permission="createRecordCondition2" />
              </qx:button>         
              
              <qx:button label="Permission 'createRecord' and condition 1,2,3" >
                <qcl:observe property="enabled" permission="createRecordCondition3" />
              </qx:button>       
              
              <qx:spacer />
              
              <!-- enable button if the right server is selected -->
              <qcl:access>
                <qcl:permission name="qclServer" granted="true">
                  <qcl:updater 
                    target="this.getApplication()" 
                    event="changeServer" />
                  <qcl:condition>return this.getApplication().getServer()=="qcl";</qcl:condition>
                </qcl:permission>                              
              </qcl:access>
                            
              <qx:button label="Start server dialog demo" >
               <qcl:observe property="enabled" permission="qclServer" />
                <qxt:listener event="execute">
                  this.getApplication().startServerDialog();
                </qxt:listener>
              </qx:button>                                            
              
            </qx:vbox>
          
          </qx:groupBox>

          <qx:groupBox qxt:flex="1" legend="Configuration">
          
            <qx:vbox spacing="5">
            
              <qx:label rich="true" qxt:flex="1" width="200" allowStretchX="true">
                <qxt:property name="value">
                  <![CDATA[
                   <p>Users can change configuration values according to their permissions.
                   Changes are sent to the server and persist through page reloads.</p>
                   <p>If you use the qcl backend, configuration values can be configured to
                   have user variants, i.e. all non-global values will be specifig to the 
                   current user.</p> 
                   ]]>
                </qxt:property>
              </qx:label>          

              <qx:composite>
              <qx:grid spacing="5">
                <qx:column minWidth="100" />
                <qx:column flex="2"/>
                
                 <!-- 
                  global config key 'adminValue', the form field is protected
                  by the permission 'changeAdminValue', which is given to the
                  administrator only.
                 -->
                <qx:label value="adminValue" qxt:row="0" qxt:column="0">
                  <qcl:observe property="enabled" permission="changeAdminValue" />
                </qx:label>
                <qx:textField qxt:row="0" qxt:column="1">
                  <qcl:observe property="enabled" permission="changeAdminValue" />
                  <qcl:bind property="value" config="adminValue"  />
                </qx:textField>
                
                <!-- 
                  All other config keys are user values. The following are protected
                  by the 'changeConfig' permission
                 -->
                
                <!-- text value -->
                <qx:label value="userValue" qxt:row="1" qxt:column="0">
                  <qcl:observe property="enabled" permission="changeConfig" />
                </qx:label>
                <qx:textField qxt:row="1" qxt:column="1">
                  <qcl:observe property="enabled" permission="changeConfig" />
                  <qcl:bind property="value" config="userValue"  />              
                </qx:textField>
                
                <!-- boolean value -->
                <qx:label value="boolValue" qxt:row="2" qxt:column="0">
                  <qcl:observe property="enabled" permission="changeConfig"/>
                </qx:label>
                
                <qx:checkBox qxt:row="2" qxt:column="1">
                  <qcl:observe property="enabled" permission="changeConfig"/>
                  <qcl:bind property="value" config="boolValue"  />
                </qx:checkBox>
                
                <!-- integer value  -->
                <qx:label value="intValue" qxt:row="3" qxt:column="0">
                  <qcl:observe property="enabled" permission="changeConfig"/>
                </qx:label>
                <qx:slider orientation="horizontal" minimum="0" maximum="10" value="0"
                   qxt:row="3" qxt:column="1"> 
                   <qcl:bind property="value" config="intValue" />
                </qx:slider>

              </qx:grid>
              </qx:composite>
              
            </qx:vbox>
          </qx:groupBox>

        </qx:hbox>
      </qx:composite>
      
      <!-- source code -->
      <qx:groupBox legend="Source">
        <qx:hbox spacing="5">
           <qx:button label="Application JS source">
            <qxt:listener event="execute">
              window.open("../source/class/access/Main.js");
            </qxt:listener>            
           </qx:button>          
           <qx:button label="Toolbar XML source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/ToolBar.xml");
            </qxt:listener>
           </qx:button>
           <qx:button label="Toolbar Js source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/ToolBar.js");
            </qxt:listener>
           </qx:button>           
           <qx:button label="Body XML source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/Body.xml");
            </qxt:listener>
           </qx:button>
           <qx:button label="Body JS source">
            <qxt:listener event="execute">
              window.open("../source/class/access/components/Body.js");
            </qxt:listener>            
           </qx:button>        
        </qx:hbox>
      </qx:groupBox>

    </qx:vbox>
  </qx:composite>

</qxt:component>